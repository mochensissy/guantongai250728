# 250809-1610 解决批量删除、主页页面替换问题

本文记录本次两个问题的完整解决方案：

- 批量删除后返回首页/再次进入仪表板，被删记录“回流”的问题
- 仪表板页面“欢迎区”与已上线 Landing Page 内容重复，改为上传页功能块

---

## 一、批量删除“回流”问题（已彻底修复）

### 1) 现象
- 在仪表板批量删除学习记录后，返回首页再进入或刷新页面，被删记录会重新出现。

### 2) 根因
- 仅做了 UI 层移除或本地存储删除，但当云端/导入数据再次写回本地缓存时，没有“删除标记”，导致旧数据被回灌。

### 3) 方案设计
- 引入“软删除墓碑（tombstone）”+ 物理清理的组合策略：
  - 删除时：
    - `src/utils/storage.ts/deleteSession()` 持久化删除，并把 `id` 写入 `ai-learning-platform-deleted-ids` 墓碑清单。
  - 读取时：
    - `getAllSessions()` 在返回前过滤墓碑 ID，避免显示回流。
  - 云端同步：
    - `src/services/hybridStorage.ts` 在“从云端获取”以及“回写本地缓存”前过滤墓碑，彻底阻断云端将已删记录回写本地。
  - 导入：
    - 导入成功触发 `storageImported` 事件，仪表板收到后刷新；（如需“导入也保留已删状态”，可不清墓碑）。
  - 页面入口：
    - `pages/dashboard.tsx` 初始化与收到 `storageImported` 时先执行 `purgeTombstonedSessions()` 对本地数据做物理清理，再加载列表，确保跨页不回流。

### 4) 关键实现点
- `src/utils/storage.ts`
  - 新增墓碑键：`ai-learning-platform-deleted-ids`
  - `getAllSessions()` 过滤墓碑
  - `deleteSession()` 持久化删除 + 写墓碑
  - `purgeTombstonedSessions()` 物理剔除墓碑对应会话

- `src/services/hybridStorage.ts`
  - `getAllSessions()` 返回前、`updateLocalCache('sessions')` 写缓存前均过滤墓碑

- `pages/dashboard.tsx`
  - 删除交互采用“落地优先 + 乐观更新”：
    - 先调用本地 `deleteSession(id)`（写墓碑、写存储），UI 立即移除，再异步云端删除
    - 批量删除同理；失败项局部回滚并提示
  - 页面加载+导入事件：`purgeTombstonedSessions()` → `getAllSessions()` → `setSessions()`

### 5) 验证要点
- 批量删除 → 回到首页 → 再进仪表板：删除项不再出现
- 断网/联网状态均不回流；导入后列表立即刷新

---

## 二、仪表板“欢迎区”替换为上传页功能块

### 1) 现象
- 已有独立 Landing Page 后，仪表板顶部“欢迎区”视觉与功能重复。

### 2) 目标
- 将仪表板“欢迎区”替换为上传页的完整流程块：上传 → 生成/确认大纲 → 选择水平 → 创建会话并跳转。
- 不改动学习历史、API 设置、同步等任何既有逻辑。

### 3) 方案
- 在 `pages/dashboard.tsx`：
  - 动态引入并内嵌 `DocumentUploader`，保持与 `/upload` 一致的处理链：
    - 生成大纲：`generateOutline()` + `fixExistingOutline()`
    - 选择“小白/高手”，点击“开始学习”即创建会话并跳转
  - 局部包裹 `ThemeProvider`，确保 `OutlineEditor` 的主题风格正常
  - 增加滚动定位，切换步骤时平滑回到上传区域，不再自动跳到“学习历史”

### 4) 影响范围
- 仅仪表板呈现层；其余页面与逻辑保持不变。

---

## 三、提交信息
- 提交信息建议：`feat: 仪表板欢迎区替换为上传流程；fix: 批量删除回流问题（墓碑+清理）`
- 发布备注：不影响其他页面与数据结构，纯前端增强与防回灌策略。

