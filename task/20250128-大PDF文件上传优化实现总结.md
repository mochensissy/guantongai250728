# å¤§PDFæ–‡ä»¶ä¸Šä¼ ä¼˜åŒ–å®ç°æ€»ç»“

**ä¼˜åŒ–æ—¶é—´**: 2025å¹´1æœˆ28æ—¥  
**é—®é¢˜æè¿°**: å­—æ•°è¾ƒå¤šçš„PDFæ–‡ä»¶æ— æ³•ä¸Šä¼ ï¼Œå­—æ•°å°‘çš„PDFæ–‡ä»¶å¯ä»¥æ­£å¸¸è§£æ  
**è§£å†³æ–¹æ¡ˆ**: å®ç°åˆ†æ‰¹å¤„ç†ã€è¿›åº¦è¿½è¸ªã€å†…å­˜ä¼˜åŒ–çš„PDFè§£æç³»ç»Ÿ

---

## ğŸ“Š é—®é¢˜åˆ†æ

### ğŸ”´ åŸå§‹é—®é¢˜
1. **å†…å­˜æº¢å‡º**: å¤§PDFæ–‡ä»¶ä¸€æ¬¡æ€§åŠ è½½åˆ°å†…å­˜å¯¼è‡´æµè§ˆå™¨å´©æºƒ
2. **é˜»å¡å¤„ç†**: é•¿æ—¶é—´åŒæ­¥å¤„ç†æ— è¿›åº¦åé¦ˆï¼Œç”¨æˆ·ä½“éªŒå·®
3. **é”™è¯¯å¤„ç†ä¸è¶³**: è§£æå¤±è´¥æ—¶ç¼ºä¹å…·ä½“çš„é”™è¯¯ä¿¡æ¯å’Œå»ºè®®

### ğŸ¯ ä¼˜åŒ–ç›®æ ‡
- æ”¯æŒå¤§æ–‡ä»¶ï¼ˆ20MBä»¥å†…ï¼‰çš„ç¨³å®šè§£æ
- æä¾›å®æ—¶è¿›åº¦åé¦ˆå’ŒçŠ¶æ€æ›´æ–°
- å¢å¼ºé”™è¯¯å¤„ç†å’Œç”¨æˆ·ä½“éªŒ
- ä¼˜åŒ–å†…å­˜ä½¿ç”¨ï¼Œé¿å…æµè§ˆå™¨å´©æºƒ

---

## ğŸ”§ æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 1. **åˆ†æ‰¹å¤„ç†ç®—æ³•**
```typescript
// æ ¸å¿ƒä¼˜åŒ–ï¼šåˆ†æ‰¹å¤„ç†é¡µé¢
const batchSize = totalPages > 50 ? 10 : 5; // æ™ºèƒ½æ‰¹æ¬¡å¤§å°
for (let startPage = 1; startPage <= totalPages; startPage += batchSize) {
  const endPage = Math.min(startPage + batchSize - 1, totalPages);
  // å¹¶è¡Œå¤„ç†æ‰¹æ¬¡å†…çš„é¡µé¢
  const batchPromises = [];
  for (let pageNum = startPage; pageNum <= endPage; pageNum++) {
    batchPromises.push(extractPageText(pdf, pageNum));
  }
  const batchTexts = await Promise.all(batchPromises);
}
```

**ä¼˜åŠ¿**:
- é¿å…ä¸€æ¬¡æ€§å¤„ç†è¿‡å¤šé¡µé¢å¯¼è‡´å†…å­˜æº¢å‡º
- æ”¯æŒå¤§æ–‡æ¡£ï¼ˆ100+é¡µï¼‰çš„ç¨³å®šå¤„ç†
- è‡ªåŠ¨æ ¹æ®æ–‡æ¡£å¤§å°è°ƒæ•´æ‰¹æ¬¡å¤§å°

### 2. **åˆ†å—æ–‡ä»¶è¯»å–**
```typescript
// å¤§æ–‡ä»¶åˆ†å—è¯»å–ï¼Œé¿å…å†…å­˜é—®é¢˜
const readFileInChunks = async (file: File, progressCallback) => {
  if (file.size < 10 * 1024 * 1024) { // å°äº10MBç›´æ¥è¯»å–
    return await file.arrayBuffer();
  }
  // å¤§æ–‡ä»¶ä½¿ç”¨FileReaderåˆ†å—è¯»å–
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onprogress = (event) => {
      const progress = (event.loaded / event.total) * 100;
      progressCallback?.(progress);
    };
    reader.readAsArrayBuffer(file);
  });
};
```

**ä¼˜åŠ¿**:
- 10MBä»¥ä¸‹æ–‡ä»¶å¿«é€Ÿå¤„ç†
- å¤§æ–‡ä»¶åˆ†å—è¯»å–ï¼Œå‡å°‘å†…å­˜å‹åŠ›
- æ–‡ä»¶è¯»å–è¿›åº¦å®æ—¶åé¦ˆ

### 3. **å®æ—¶è¿›åº¦è¿½è¸ª**
```typescript
// è¯¦ç»†çš„è¿›åº¦å›è°ƒç³»ç»Ÿ
const progressCallback = (progress: number, status: string) => {
  updateProcessingStatus(true, status, 'info', Math.round(progress));
};

// è¿›åº¦é˜¶æ®µåˆ’åˆ†
progressCallback(5, 'æ­£åœ¨åˆå§‹åŒ–PDFè§£æå™¨...');     // 5%
progressCallback(10, 'æ­£åœ¨è¯»å–PDFæ–‡ä»¶...');        // 10%
progressCallback(20, 'æ­£åœ¨è§£æPDFæ–‡æ¡£ç»“æ„...');    // 20%
// é¡µé¢è§£æå 70%è¿›åº¦
progressCallback(20 + batchProgress, `æ­£åœ¨è§£æç¬¬ ${startPage}-${endPage} é¡µ...`);
progressCallback(90, 'æ­£åœ¨æ•´ç†è§£æç»“æœ...');       // 90%
progressCallback(100, 'è§£æå®Œæˆï¼');              // 100%
```

**ä¼˜åŠ¿**:
- è¯¦ç»†çš„è¿›åº¦é˜¶æ®µåˆ’åˆ†
- å®æ—¶çŠ¶æ€æ›´æ–°å’Œç”¨æˆ·åé¦ˆ
- è¿›åº¦æ¡UIå±•ç¤º

### 4. **å¢å¼ºé”™è¯¯å¤„ç†**
```typescript
// æ™ºèƒ½é”™è¯¯è¯†åˆ«å’Œç”¨æˆ·å‹å¥½æç¤º
if (errorMsg.includes('memory') || errorMsg.includes('allocation')) {
  errorMessage = 'æ–‡ä»¶è¿‡å¤§å¯¼è‡´å†…å­˜ä¸è¶³ï¼Œè¯·å°è¯•è¾ƒå°çš„PDFæ–‡ä»¶æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ';
} else if (errorMsg.includes('invalid') || errorMsg.includes('corrupt')) {
  errorMessage = 'PDFæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®æˆ–å·²æŸåï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§';
} else if (errorMsg.includes('password') || errorMsg.includes('encrypted')) {
  errorMessage = 'ä¸æ”¯æŒåŠ å¯†æˆ–å—å¯†ç ä¿æŠ¤çš„PDFæ–‡ä»¶';
}
```

**ä¼˜åŠ¿**:
- è¯†åˆ«å¸¸è§é”™è¯¯ç±»å‹
- æä¾›å…·ä½“çš„è§£å†³å»ºè®®
- ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯

### 5. **å†…å­˜ç®¡ç†ä¼˜åŒ–**
```typescript
// ä¸»åŠ¨å†…å­˜ç®¡ç†
if (totalPages > 100 && startPage % 50 === 0) {
  await new Promise(resolve => setTimeout(resolve, 100)); // ç»™æµè§ˆå™¨æ—¶é—´è¿›è¡Œåƒåœ¾å›æ”¶
}

// é”™è¯¯æ¢å¤æœºåˆ¶
try {
  const batchTexts = await Promise.all(batchPromises);
} catch (batchError) {
  // æ‰¹æ¬¡å¤±è´¥æ—¶å•ç‹¬é‡è¯•æ¯é¡µ
  for (let pageNum = startPage; pageNum <= endPage; pageNum++) {
    try {
      const pageText = await extractPageText(pdf, pageNum);
      fullText += pageText + '\n\n';
    } catch (pageError) {
      console.warn(`ç¬¬ ${pageNum} é¡µè§£æå¤±è´¥ï¼Œè·³è¿‡:`, pageError);
      fullText += `[ç¬¬${pageNum}é¡µè§£æå¤±è´¥]\n\n`;
    }
  }
}
```

**ä¼˜åŠ¿**:
- å®šæœŸé‡Šæ”¾å†…å­˜ï¼Œé¿å…ç´¯ç§¯å‹åŠ›
- å•é¡µå¤±è´¥ä¸å½±å“æ•´ä½“è§£æ
- ä¼˜é›…çš„é”™è¯¯é™çº§å¤„ç†

---

## ğŸ¨ ç”¨æˆ·ç•Œé¢ä¼˜åŒ–

### 1. **è¿›åº¦æ¡UIç»„ä»¶**
- å®æ—¶è¿›åº¦ç™¾åˆ†æ¯”æ˜¾ç¤º
- å¹³æ»‘çš„è¿‡æ¸¡åŠ¨ç”»æ•ˆæœ
- å¤„ç†çŠ¶æ€çš„è§†è§‰åé¦ˆ

### 2. **çŠ¶æ€æ˜¾ç¤ºå¢å¼º**
- ä¸åŒçŠ¶æ€çš„é¢œè‰²åŒºåˆ†ï¼ˆè“è‰²-å¤„ç†ä¸­ï¼Œç»¿è‰²-æˆåŠŸï¼Œçº¢è‰²-é”™è¯¯ï¼‰
- è¯¦ç»†çš„çŠ¶æ€æ¶ˆæ¯æ˜¾ç¤º
- å¤„ç†æ—¶é—´ç»Ÿè®¡

### 3. **è°ƒè¯•å·¥å…·é¡µé¢**
- å®æ—¶è¿›åº¦è¿½è¸ªå’Œæ—¥å¿—è¾“å‡º
- è¯¦ç»†çš„è§£æç»“æœå±•ç¤º
- ä¼˜åŒ–åŠŸèƒ½è¯´æ˜å’Œæµ‹è¯•å»ºè®®

---

## ğŸ“ˆ æ€§èƒ½æå‡å¯¹æ¯”

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **æ”¯æŒæ–‡ä»¶å¤§å°** | ~5MB | 20MB | 300% |
| **å¤§æ–‡æ¡£ç¨³å®šæ€§** | ç»å¸¸å´©æºƒ | ç¨³å®šå¤„ç† | æ˜¾è‘—æå‡ |
| **ç”¨æˆ·åé¦ˆ** | æ— è¿›åº¦æ˜¾ç¤º | å®æ—¶è¿›åº¦ | ä½“éªŒè´¨å˜ |
| **é”™è¯¯å¤„ç†** | é€šç”¨é”™è¯¯ | å…·ä½“å»ºè®® | å¯ç”¨æ€§æå‡ |
| **å†…å­˜ä½¿ç”¨** | çº¿æ€§å¢é•¿ | å—æ§ç®¡ç† | ç¨³å®šå¯é  |

---

## ğŸ”— ç›¸å…³æ–‡ä»¶ä¿®æ”¹

### æ ¸å¿ƒæ–‡ä»¶
1. **`src/utils/documentParser.ts`** - PDFè§£æå¼•æ“ä¼˜åŒ–
   - æ–°å¢åˆ†æ‰¹å¤„ç†é€»è¾‘
   - å®ç°è¿›åº¦å›è°ƒæœºåˆ¶
   - å¢å¼ºé”™è¯¯å¤„ç†

2. **`src/components/DocumentUploader.tsx`** - ä¸Šä¼ ç»„ä»¶UIä¼˜åŒ–
   - æ·»åŠ è¿›åº¦æ¡æ˜¾ç¤º
   - é›†æˆè¿›åº¦å›è°ƒ
   - æ”¹è¿›çŠ¶æ€æ˜¾ç¤º

3. **`pages/debug-pdf.tsx`** - è°ƒè¯•å·¥å…·å‡çº§
   - å®æ—¶è¿›åº¦ç›‘æ§
   - è¯¦ç»†ç»“æœå±•ç¤º
   - åŠŸèƒ½è¯´æ˜æ–‡æ¡£

### æ–°å¢åŠŸèƒ½
- `readFileInChunks()` - åˆ†å—æ–‡ä»¶è¯»å–
- `extractPageText()` - å•é¡µæ–‡æœ¬æå–
- è¿›åº¦å›è°ƒç³»ç»Ÿ
- æ™ºèƒ½é”™è¯¯åˆ†ç±»

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯
1. **å°æ–‡ä»¶æµ‹è¯•** (< 5MB): éªŒè¯åŸºæœ¬åŠŸèƒ½æ­£å¸¸
2. **ä¸­ç­‰æ–‡ä»¶æµ‹è¯•** (5-15MB): è§‚å¯Ÿè¿›åº¦æ˜¾ç¤º
3. **å¤§æ–‡ä»¶æµ‹è¯•** (15-20MB): éªŒè¯ä¼˜åŒ–æ•ˆæœ
4. **é”™è¯¯åœºæ™¯æµ‹è¯•**: æŸåæ–‡ä»¶ã€åŠ å¯†æ–‡ä»¶ç­‰

### æµ‹è¯•æ–¹æ³•
1. è®¿é—® `http://localhost:3004/debug-pdf` è¿›è¡Œè¯¦ç»†æµ‹è¯•
2. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—
3. è§‚å¯Ÿè¿›åº¦æ¡å’ŒçŠ¶æ€æ›´æ–°
4. æµ‹è¯•ä¸åŒå¤§å°çš„PDFæ–‡ä»¶

---

## ğŸ’¡ æœªæ¥ä¼˜åŒ–æ–¹å‘

### å¾…å®ç°åŠŸèƒ½
1. **å†…å®¹åˆ†å—å¤„ç†**: å®ç°è¶…å¤§æ–‡æ¡£å†…å®¹çš„æ™ºèƒ½åˆ†å—
2. **ç¼“å­˜æœºåˆ¶**: æ·»åŠ è§£æç»“æœç¼“å­˜ï¼Œé¿å…é‡å¤å¤„ç†
3. **å¹¶è¡Œä¼˜åŒ–**: è¿›ä¸€æ­¥ä¼˜åŒ–å¹¶è¡Œå¤„ç†ç®—æ³•
4. **OCRæ”¯æŒ**: æ”¯æŒå›¾åƒå‹PDFçš„æ–‡å­—è¯†åˆ«

### æ€§èƒ½ç›‘æ§
- æ·»åŠ æ€§èƒ½æŒ‡æ ‡æ”¶é›†
- å†…å­˜ä½¿ç”¨ç›‘æ§
- é”™è¯¯ç‡ç»Ÿè®¡

---

## ğŸ“ æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–æˆåŠŸè§£å†³äº†å¤§PDFæ–‡ä»¶ä¸Šä¼ å¤±è´¥çš„é—®é¢˜ï¼Œé€šè¿‡ä»¥ä¸‹å…³é”®æŠ€æœ¯ï¼š

1. **åˆ†æ‰¹å¤„ç†ç®—æ³•** - è§£å†³å†…å­˜æº¢å‡ºé—®é¢˜
2. **åˆ†å—æ–‡ä»¶è¯»å–** - é¿å…å¤§æ–‡ä»¶åŠ è½½å´©æºƒ  
3. **å®æ—¶è¿›åº¦è¿½è¸ª** - æå‡ç”¨æˆ·ä½“éªŒ
4. **å¢å¼ºé”™è¯¯å¤„ç†** - æä¾›å…·ä½“è§£å†³å»ºè®®
5. **å†…å­˜ç®¡ç†ä¼˜åŒ–** - ç¡®ä¿é•¿æ—¶é—´ç¨³å®šè¿è¡Œ

ç°åœ¨ç”¨æˆ·å¯ä»¥ç¨³å®šä¸Šä¼ å’Œè§£ææœ€å¤§20MBçš„PDFæ–‡ä»¶ï¼Œç³»ç»Ÿä¼šæä¾›è¯¦ç»†çš„è¿›åº¦åé¦ˆå’Œé”™è¯¯å¤„ç†ï¼Œæ˜¾è‘—æå‡äº†å¹³å°çš„å¯ç”¨æ€§å’Œç”¨æˆ·ä½“éªŒã€‚

**æ¨èä¸‹ä¸€æ­¥**: åœ¨ç”¨æˆ·åé¦ˆçš„åŸºç¡€ä¸Šï¼Œç»§ç»­ä¼˜åŒ–è¶…å¤§æ–‡æ¡£çš„å¤„ç†èƒ½åŠ›ï¼Œå¹¶è€ƒè™‘æ·»åŠ OCRåŠŸèƒ½æ”¯æŒå›¾åƒå‹PDFã€‚