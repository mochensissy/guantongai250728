## 概述

本方案详细记录了PDF上传功能中遇到的问题及其解决过程，主要包括“AI返回内容格式不正确”导致的大纲解析失败和“TypeError: require.e is not a function”导致的动态导入错误。

## 问题描述

1.  **AI大纲解析失败**：用户反馈PDF文件上传后，生成大纲步骤提示“解析失败”，控制台显示“AI返回的内容格式不正确”。
2.  **页面加载异常（上传页面）**：用户在点击上传文件时，上传页面出现“TypeError: require.e is not a function”的运行时错误，导致文件选择功能无法使用。
3.  **学习会话页面空白**：在解决了上传页面问题并成功生成大纲后，跳转到学习会话页面（`/learn/[sessionId]`）时，页面显示空白或“加载中...”且无内容。

## 根本原因分析与解决方案

1.  **AI大纲解析失败 (`AI返回的内容格式不正确`)**
    -   **原因**：AI服务`generateOutline`函数中，JSON解析逻辑不够健壮，只依赖一个简单的正则表达式`/\[[\s\S]*\]/`来提取JSON数组。当AI返回的内容包含额外文字、注释或以代码块（如`json`或无类型）形式包装JSON时，原有解析无法正确提取。
    -   **修复方案**：
        -   **增强JSON解析方法**：在`src/utils/aiService.ts`的`generateOutline`函数中，修改JSON解析逻辑。
            -   引入多重尝试机制：
                1.  **方法1**：直接匹配纯JSON数组 (`/\[[\s\S]*\]/`)。
                2.  **方法2**：匹配Markdown代码块中的JSON (`/```(?:json)?\\s*(\\[[\\s\\S]*?\\])\\s*```/`)。
                3.  **方法3**：作为最后的尝试，直接解析整个AI返回内容（假设是纯JSON）。
            -   增加更详细的`console.log`和`console.error`信息，以便调试时清晰看到每一步的解析状态和错误。
        -   **强化AI提示词**：在`generateOutline`函数发送给AI的提示词中，明确、严格地要求AI只返回纯JSON格式的数组，不允许任何额外文字、解释或代码块标记，并强制回复以`[`开头和`]`结尾。

2.  **页面加载异常 (`TypeError: require.e is not a function`)**
    -   **原因**：此错误通常发生在Next.js的动态导入（`next/dynamic`）中，当Webpack尝试加载模块但找不到`require.e`方法时。在项目回滚到较旧版本后，项目中某些文件使用了`@/`开头的路径别名（例如`@/utils/documentParser`），而这个旧版本可能没有正确配置`tsconfig.json`或`next.config.js`来识别这些别名路径，导致在构建或运行时无法正确解析模块。
    -   **修复方案**：
        -   **修改导入路径为相对路径**：在以下文件中，将所有`@/`开头的别名导入路径修改为相对路径，以确保模块能够正确被找到和加载：
            -   `src/components/DocumentUploader.tsx`
            -   `src/components/SessionHistoryList.tsx`
            -   `src/components/OutlineEditor.tsx`
            -   `src/components/APIConfigModal.tsx`

3.  **学习会话页面空白**
    -   **原因**：在修复上述问题后，学习会话页面（`/learn/[sessionId]`）仍然空白，主要原因在于服务器运行端口与浏览器访问端口不一致，或者localStorage中没有找到对应的会话数据。
    -   **修复方案**：
        -   **统一服务器端口**：根据当前终端中Next.js实际启动的端口（通常是3000或3001），指导用户访问正确的URL。如果需要，通过`PORT=XXXX npm run dev`命令强制Next.js在指定端口启动。
        -   **添加数据加载调试日志**：在`pages/learn/[sessionId].tsx`的`useEffect`中，添加详细的`console.log`来打印`sessionId`、`localStorage`中所有会话信息、`loadedSession`和`loadedConfig`的状态，以便于判断是数据未保存还是未加载。

## 总结

本次修复解决了PDF上传功能从前端文件解析到AI大纲生成，再到学习页面加载的整个流程中的关键问题。核心在于增强了AI返回内容的解析鲁棒性，以及统一和修正了项目中的模块导入路径问题。通过这些修复，用户现在应该能够顺利上传PDF、生成大纲并进入学习会话页面。 