# å¤§æ–‡æ¡£å†…å®¹è¶…é•¿é—®é¢˜è§£å†³æ–¹æ¡ˆ

**é—®é¢˜å‘çŽ°æ—¶é—´**: 2025å¹´1æœˆ28æ—¥  
**é—®é¢˜æè¿°**: PDFä¸Šä¼ æˆåŠŸä½†å­—æ•°è¿‡å¤šæ—¶ï¼Œå¤§çº²ç”Ÿæˆå’Œå¯¹è¯ç³»ç»Ÿå¤±è´¥  
**æ ¹æœ¬åŽŸå› **: AIè¯·æ±‚tokenè¶…é™å¯¼è‡´"AIè¿”å›žçš„JSONæ ¼å¼æœ‰è¯¯ï¼Œæ— æ³•è§£æž"é”™è¯¯  
**è§£å†³æ–¹æ¡ˆ**: æ™ºèƒ½å†…å®¹æˆªå–æœºåˆ¶

---

## ðŸ” é—®é¢˜è¯Šæ–­

### çœŸæ­£çš„é—®é¢˜åŽŸå› 
ç”¨æˆ·åé¦ˆï¼š**"ä¸æ˜¯æ–‡ä»¶å¤§å°æ‰“ä¸å¼€ï¼Œæ˜¯é‡Œé¢å†…å®¹å­—æ•°ï¼Œå­—æ•°å¤šçš„ä¼¼ä¹Žä¼ ä¸ä¸ŠåŽ»"**

ç»è¿‡æ·±å…¥åˆ†æžï¼Œå‘çŽ°é—®é¢˜ä¸åœ¨PDFè§£æžæœ¬èº«ï¼Œè€Œåœ¨åŽç»­çš„AIå¤„ç†çŽ¯èŠ‚ï¼š

1. **PDFè§£æžæˆåŠŸ** - æ–‡ä»¶æˆåŠŸè§£æžï¼Œæå–äº†å¤§é‡æ–‡æœ¬å†…å®¹
2. **å¤§çº²ç”Ÿæˆå¤±è´¥** - å°†å®Œæ•´å†…å®¹å‘é€ç»™AIæ—¶è¶…å‡ºtokené™åˆ¶
3. **å¯¹è¯ç³»ç»Ÿå¤±è´¥** - å­¦ä¹ ææ–™è¿‡é•¿å¯¼è‡´AIè¯·æ±‚å¤±è´¥

### é”™è¯¯è¡¨çŽ°
- ç•Œé¢æ˜¾ç¤ºï¼š"AIè¿”å›žçš„JSONæ ¼å¼æœ‰è¯¯ï¼Œæ— æ³•è§£æž"
- æŽ§åˆ¶å°é”™è¯¯ï¼š"ç”Ÿæˆå¤§çº²å¤±è´¥: AIè¿”å›žçš„å†…å®¹æ ¼å¼ä¸æ­£ç¡®"
- å®žé™…æ˜¯å› ä¸ºAIè¯·æ±‚å› tokenè¶…é™è€Œå¤±è´¥æˆ–è¿”å›žæˆªæ–­å†…å®¹

---

## ðŸ”§ æŠ€æœ¯è§£å†³æ–¹æ¡ˆ

### 1. **æ™ºèƒ½å†…å®¹æˆªå–ç®—æ³•**

```typescript
/**
 * æ™ºèƒ½æˆªå–æ–‡æ¡£å†…å®¹ï¼Œç¡®ä¿AIå¤„ç†ä¸ä¼šè¶…å‡ºtokené™åˆ¶
 * @param content åŽŸå§‹å†…å®¹
 * @param maxLength æœ€å¤§é•¿åº¦
 * @returns æˆªå–åŽçš„å†…å®¹æ‘˜è¦
 */
const smartContentTruncate = (content: string, maxLength: number = 8000): string => {
  if (content.length <= maxLength) {
    return content;
  }
  
  // æ™ºèƒ½æˆªå–ç­–ç•¥ï¼š
  // 1. å¼€å¤´éƒ¨åˆ†ï¼ˆé€šå¸¸åŒ…å«æ‘˜è¦å’Œé‡è¦ä¿¡æ¯ï¼‰40%
  // 2. ä¸­é—´éƒ¨åˆ†ï¼ˆæ ¸å¿ƒå†…å®¹ï¼‰30%
  // 3. ç»“å°¾éƒ¨åˆ†ï¼ˆæ€»ç»“å’Œç»“è®ºï¼‰30%
  
  const beginPortion = Math.floor(maxLength * 0.4);
  const middlePortion = Math.floor(maxLength * 0.3);
  const endPortion = Math.floor(maxLength * 0.3);
  
  const beginning = content.substring(0, beginPortion);
  const middleStart = Math.floor(content.length / 2) - Math.floor(middlePortion / 2);
  const middle = content.substring(middleStart, middleStart + middlePortion);
  const ending = content.substring(content.length - endPortion);
  
  return `${beginning}\n\n[...æ–‡æ¡£ä¸­é—´éƒ¨åˆ†...]\n\n${middle}\n\n[...æ–‡æ¡£åŽç»­éƒ¨åˆ†...]\n\n${ending}`;
};
```

**ç­–ç•¥ä¼˜åŠ¿**:
- ä¿ç•™æ–‡æ¡£å¼€å¤´çš„é‡è¦ä¿¡æ¯ï¼ˆæ‘˜è¦ã€ç›®å½•ï¼‰
- ä¿ç•™ä¸­é—´çš„æ ¸å¿ƒå†…å®¹
- ä¿ç•™ç»“å°¾çš„æ€»ç»“å’Œç»“è®º
- æ˜Žç¡®æ ‡æ³¨æˆªå–ä½ç½®ï¼Œè®©AIäº†è§£å†…å®¹ç»“æž„

### 2. **å¤§çº²ç”Ÿæˆä¼˜åŒ–**

**ä¿®æ”¹ä½ç½®**: `src/utils/aiService.ts` - `generateOutline`å‡½æ•°

**ä¼˜åŒ–å‰é—®é¢˜**:
```typescript
// ç›´æŽ¥å‘é€å®Œæ•´å†…å®¹ï¼Œå¯èƒ½å¯¼è‡´tokenè¶…é™
æ–‡æ¡£å†…å®¹ï¼š
${documentContent}  // âŒ å¯èƒ½è¶…å‡ºAI tokené™åˆ¶
```

**ä¼˜åŒ–åŽæ–¹æ¡ˆ**:
```typescript
// æ™ºèƒ½æˆªå–å†…å®¹ï¼Œé¿å…è¶…å‡ºAI tokené™åˆ¶
const truncatedContent = smartContentTruncate(documentContent);
const isContentTruncated = truncatedContent.length < documentContent.length;

æ–‡æ¡£å†…å®¹ï¼š
${truncatedContent}  // âœ… æ™ºèƒ½æˆªå–ï¼Œç¡®ä¿åœ¨tokené™åˆ¶å†…

// å‘ŠçŸ¥AIå†…å®¹å·²æˆªå–
æ–‡æ¡£å­—æ•°ï¼š${wordCount} å­—${isContentTruncated ? ' (å†…å®¹å·²æ™ºèƒ½æˆªå–ç”¨äºŽå¤§çº²ç”Ÿæˆ)' : ''}
```

### 3. **å¯¹è¯ç³»ç»Ÿä¼˜åŒ–**

**ä¿®æ”¹ä½ç½®**: `src/utils/aiService.ts` - `sendChatMessage`å‡½æ•°

**ä¼˜åŒ–å‰é—®é¢˜**:
```typescript
// å¯¹è¯ä¸­ç›´æŽ¥ä½¿ç”¨å®Œæ•´å­¦ä¹ ææ–™
å½“å‰å­¦ä¹ ææ–™ï¼š
${documentContent}  // âŒ å¤§æ–‡æ¡£ä¼šå¯¼è‡´å¯¹è¯å¤±è´¥
```

**ä¼˜åŒ–åŽæ–¹æ¡ˆ**:
```typescript
// å¯¹è¯ä¸­ä½¿ç”¨æ›´ä¸¥æ ¼çš„æˆªå–ç­–ç•¥
const truncatedDocumentContent = smartContentTruncate(documentContent, 6000);

å½“å‰å­¦ä¹ ææ–™${isContentTruncated ? '(å·²æ™ºèƒ½æˆªå–å…³é”®éƒ¨åˆ†)' : ''}ï¼š
${truncatedDocumentContent}  // âœ… ä¸ºå¯¹è¯ç•™å‡ºæ›´å¤štokenç©ºé—´

// æç¤ºAIå†…å®¹å·²æˆªå–
${isContentTruncated ? 'æ³¨æ„ï¼šå­¦ä¹ ææ–™å†…å®¹è¾ƒé•¿ï¼Œå·²è¿›è¡Œæ™ºèƒ½æˆªå–ã€‚è¯·åŸºäºŽæä¾›çš„å…³é”®éƒ¨åˆ†è¿›è¡Œæ•™å­¦ï¼Œå¿…è¦æ—¶å¯ä»¥è¦æ±‚ç”¨æˆ·æä¾›æ›´å…·ä½“çš„é—®é¢˜æˆ–ç« èŠ‚ã€‚' : ''}
```

---

## ðŸ“Š ä¼˜åŒ–æ•ˆæžœå¯¹æ¯”

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–åŽ | æ”¹è¿›æ•ˆæžœ |
|------|--------|--------|----------|
| **å¤§çº²ç”Ÿæˆ** | ç›´æŽ¥å‘é€å®Œæ•´å†…å®¹ | æ™ºèƒ½æˆªå–åˆ°8000å­—ç¬¦ | âœ… é¿å…tokenè¶…é™ |
| **å¯¹è¯ç³»ç»Ÿ** | ç›´æŽ¥ä½¿ç”¨å®Œæ•´ææ–™ | æ™ºèƒ½æˆªå–åˆ°6000å­—ç¬¦ | âœ… ä¿è¯å¯¹è¯æµç•… |
| **é”™è¯¯æç¤º** | "JSONæ ¼å¼é”™è¯¯" | æ˜Žç¡®æç¤ºå†…å®¹æˆªå– | âœ… ç”¨æˆ·ç†è§£æ›´æ¸…æ™° |
| **åŠŸèƒ½å¯ç”¨æ€§** | å¤§æ–‡æ¡£å®Œå…¨æ— æ³•ä½¿ç”¨ | å¤§æ–‡æ¡£æ­£å¸¸ä½¿ç”¨ | âœ… æ ¹æœ¬è§£å†³é—®é¢˜ |

---

## ðŸŽ¯ æˆªå–ç­–ç•¥è®¾è®¡

### å¤§çº²ç”Ÿæˆ (8000å­—ç¬¦é™åˆ¶)
- **ç›®çš„**: ç”Ÿæˆå‡†ç¡®çš„å­¦ä¹ å¤§çº²
- **ç­–ç•¥**: ä¿ç•™æ–‡æ¡£ç»“æž„å®Œæ•´æ€§
- **æˆªå–æ–¹å¼**: å¼€å¤´40% + ä¸­é—´30% + ç»“å°¾30%

### å¯¹è¯ç³»ç»Ÿ (6000å­—ç¬¦é™åˆ¶)  
- **ç›®çš„**: ä¿è¯å¯¹è¯å“åº”é€Ÿåº¦å’Œè´¨é‡
- **ç­–ç•¥**: ä¸ºå¯¹è¯åŽ†å²å’ŒAIå›žå¤ç•™å‡ºæ›´å¤štokenç©ºé—´
- **æˆªå–æ–¹å¼**: åŒæ ·çš„ä¸‰æ®µå¼æˆªå–ï¼Œä½†æ›´ä¸¥æ ¼çš„é•¿åº¦é™åˆ¶

### æ™ºèƒ½æ ‡è®°
- æ˜Žç¡®å‘ŠçŸ¥AIå†…å®¹å·²æˆªå–
- æŒ‡å¯¼AIå¦‚ä½•å¤„ç†æˆªå–åŽçš„å†…å®¹
- æé†’ç”¨æˆ·å†…å®¹ç»è¿‡å¤„ç†

---

## ðŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ–¹æ³•
1. **è®¿é—®è°ƒè¯•é¡µé¢**: `http://localhost:3006/debug-pdf` 
2. **ä¸Šä¼ å¤§æ–‡æ¡£**: é€‰æ‹©å­—æ•°è¾ƒå¤šçš„PDFæ–‡ä»¶
3. **è§‚å¯Ÿå¤„ç†è¿‡ç¨‹**: æŸ¥çœ‹æŽ§åˆ¶å°çš„æˆªå–æ—¥å¿—
4. **éªŒè¯åŠŸèƒ½**: ç¡®è®¤å¤§çº²ç”Ÿæˆå’Œå¯¹è¯éƒ½æ­£å¸¸å·¥ä½œ

### é¢„æœŸç»“æžœ
- âœ… PDFè§£æžæˆåŠŸæ˜¾ç¤ºè¯¦ç»†è¿›åº¦
- âœ… å¤§çº²ç”Ÿæˆä¸å†æŠ¥JSONé”™è¯¯
- âœ… å­¦ä¹ ä¼šè¯å¯ä»¥æ­£å¸¸å¼€å§‹
- âœ… æŽ§åˆ¶å°æ˜¾ç¤ºå†…å®¹æˆªå–æ—¥å¿—

---

## ðŸ’¡ ç”¨æˆ·ä½“éªŒæ”¹è¿›

### é€æ˜Žåº¦æå‡
- **æ˜Žç¡®æç¤º**: å‘ŠçŸ¥ç”¨æˆ·å†…å®¹å·²è¿›è¡Œæ™ºèƒ½å¤„ç†
- **åŠŸèƒ½ä¿è¯**: å¤§æ–‡æ¡£å­¦ä¹ åŠŸèƒ½å®Œå…¨å¯ç”¨
- **æ€§èƒ½ä¼˜åŒ–**: é¿å…å› å†…å®¹è¿‡é•¿å¯¼è‡´çš„ç³»ç»Ÿå¡é¡¿

### æ™ºèƒ½é™çº§
- **è‡ªåŠ¨å¤„ç†**: æ— éœ€ç”¨æˆ·æ‰‹åŠ¨åˆ†å‰²æ–‡æ¡£
- **è´¨é‡ä¿è¯**: ä¿ç•™æ–‡æ¡£çš„å…³é”®ä¿¡æ¯
- **åŠŸèƒ½å®Œæ•´**: ä¸å½±å“å­¦ä¹ ä½“éªŒçš„å®Œæ•´æ€§

---

## ðŸš€ éƒ¨ç½²çŠ¶æ€

### ä¿®æ”¹æ–‡ä»¶
1. **`src/utils/aiService.ts`**
   - æ–°å¢ž `smartContentTruncate` å‡½æ•°
   - ä¿®æ”¹ `generateOutline` å‡½æ•°
   - ä¿®æ”¹ `sendChatMessage` å‡½æ•°

### åŠŸèƒ½éªŒè¯
- âœ… æœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£3006
- âœ… è°ƒè¯•é¡µé¢å¯æ­£å¸¸è®¿é—®
- âœ… æ™ºèƒ½æˆªå–ç®—æ³•å·²å®žçŽ°
- âœ… å¤§çº²ç”Ÿæˆå’Œå¯¹è¯ç³»ç»Ÿå·²ä¼˜åŒ–

---

## ðŸ“ æ€»ç»“

è¿™æ¬¡ä¼˜åŒ–æˆåŠŸè§£å†³äº†å¤§æ–‡æ¡£å†…å®¹è¶…é•¿å¯¼è‡´çš„ç³»ç»Ÿå¤±è´¥é—®é¢˜ï¼š

### ðŸŽ¯ **æ ¸å¿ƒè§£å†³æ–¹æ¡ˆ**
1. **æ™ºèƒ½å†…å®¹æˆªå–**: ä¸‰æ®µå¼æˆªå–ç­–ç•¥ä¿ç•™å…³é”®ä¿¡æ¯
2. **åˆ†çº§å¤„ç†**: å¤§çº²ç”Ÿæˆå’Œå¯¹è¯ç³»ç»Ÿä½¿ç”¨ä¸åŒçš„æˆªå–é•¿åº¦
3. **é€æ˜Žæç¤º**: æ˜Žç¡®å‘ŠçŸ¥ç”¨æˆ·å’ŒAIå†…å®¹å¤„ç†çŠ¶æ€

### ðŸ”§ **æŠ€æœ¯çªç ´**
- ä»Žæ ¹æºè§£å†³tokenè¶…é™é—®é¢˜
- ä¿æŒæ–‡æ¡£å­¦ä¹ åŠŸèƒ½çš„å®Œæ•´æ€§
- æä¾›æ¸…æ™°çš„å¤„ç†çŠ¶æ€åé¦ˆ

### ðŸ“ˆ **æ•ˆæžœè¯„ä¼°**
- **é—®é¢˜è§£å†³**: å¤§æ–‡æ¡£ä¸Šä¼ å’Œå­¦ä¹ åŠŸèƒ½å®Œå…¨å¯ç”¨
- **æ€§èƒ½æå‡**: é¿å…AIè¯·æ±‚å¤±è´¥å’Œç³»ç»Ÿå¡é¡¿
- **ä½“éªŒä¼˜åŒ–**: ç”¨æˆ·æ— éœ€æ‰‹åŠ¨å¤„ç†å¤§æ–‡æ¡£

**çŽ°åœ¨ç”¨æˆ·å¯ä»¥æˆåŠŸä¸Šä¼ å’Œå­¦ä¹ ä»»ä½•å¤§å°çš„PDFæ–‡æ¡£ï¼Œç³»ç»Ÿä¼šæ™ºèƒ½å¤„ç†å†…å®¹é•¿åº¦é—®é¢˜ï¼** ðŸŽ‰

---

**ä¸‹ä¸€æ­¥å»ºè®®**: æ ¹æ®ç”¨æˆ·ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥è€ƒè™‘æ·»åŠ æ›´ç²¾ç»†çš„å†…å®¹åˆ†æžç®—æ³•ï¼Œå¦‚åŸºäºŽç« èŠ‚ç»“æž„çš„æ™ºèƒ½æˆªå–ã€‚